unit sys_netUpd;

interface
uses Windows,WinInet,ShellAPI,
 Classes,
 IdBaseComponent,IdComponent, IdTCPConnection, IdTCPClient, IdFTP;

implementation
uses SysUtils,FileUtil;

function IsConnectedToNetwork: bool;
var
  dwConnectionTypes: DWORD;
begin
  dwConnectionTypes :=
    INTERNET_CONNECTION_MODEM +
    INTERNET_CONNECTION_LAN +
    INTERNET_CONNECTION_PROXY;
  result := InternetGetConnectedState(@dwConnectionTypes, 0);
end;

function GetFileFromNetwork(const appName,fileURL,FileName: string): bool;
const
  BufferSize = 1024;
var
  hSession, hURL: HInternet;
  Buffer: array[1..BufferSize] of Byte;
  BufferLen: DWORD;
  f: file;
  sAppName: string;
begin
  Result := False;
  sAppName := ExtractFileName(AppName);
  hSession := InternetOpen(PChar(sAppName), INTERNET_OPEN_TYPE_PRECONFIG, nil, nil, 0);
  try
    hURL := InternetOpenURL(hSession, PChar(fileURL), nil, 0, 0, 0);
    try
      AssignFile(f, FileName);
      Rewrite(f,1);
      repeat
        InternetReadFile(hURL, @Buffer, SizeOf(Buffer), BufferLen);
        BlockWrite(f, Buffer, BufferLen);
      until
      BufferLen = 0;
      CloseFile(f);
      Result := True;
    finally
      InternetCloseHandle(hURL);
    end;
  finally
    InternetCloseHandle(hSession);
  end;
end;


function IsNetworkAutoUpdated(aFileURL: String; aFtp: TidFTP; slLog: TStrings): Integer;
var
  lCaption,vCaption,tCaption,sCaption,s, txt: string;
  i: integer;

begin
  result := -2;
  if not IsConnectedToNetwork then Exit;
  slLog.Add('Try connect to ...');
  try
    s := '';
//    s := aFtp.Get(aFileURL: string; const ADestFile: string; const ACanOverwrite: boolean = false; AResume: Boolean = false);
    tCaption := Copy(s, pos('', s) + 7, pos('', s) - pos('', s) -7);
    sCaption := Copy(s, pos('<size-->', s) + 6, pos('', s) - pos('<size>', s) -6);
    vCaption := Copy(s, pos('<version>', s) + 9, pos('</version>', s) - pos('<version>', s) -9);
    lCaption := Copy(s, pos('', s) + 7, pos('', s) - pos('', s) -7);

  finally

  end;
end;


(*

 begin
 //???????? ???? ?? ?????????? ? ???????????! ???? ???? ?? ???????? ???????? ??????????.
 if IsConnectedToInternet then
   begin
    Memo1.Lines.Add('['+timetostr(time)+'] - ???????????? ? ???????');
    s := IdHTTP1.Get('http://yoursite.ru/project.html');  // Get ?????? ?? ???????? ? ???????????
    title.Caption := Copy(s, pos('', s) + 7, pos('', s) - pos('', s) -7); //???????? ????????, ? ???????
    size.Caption := Copy(s, pos('<size-->', s) + 6, pos('', s) - pos('<size>', s) -6); //?????? ?????, ??????: 356 KB
    version.caption := Copy(s, pos('<version>', s) + 9, pos('</version>', s) - pos('<version>', s) -9); //??????, ? ?? ??????????? ??? ?????? ???, ????? <version>1</version>, ??? ??????? ?????.
    link.caption := Copy(s, pos('', s) + 7, pos('', s) - pos('', s) -7); //?????? ??  ?????????? ?????
    begin //strtofloat, ?.?. ???? Label1.Caption ?????? "0", ?? ?????????? ????.
    if strtofloat(label1.caption)>0 then
    begin
    Memo1.Lines.Add('['+timetostr(time)+'] - ???????? ????? ??????!');
    sleep(500);
 if MessageDlg('new version availab;e! ?????? ???????????', mtConfirmation,
      [mbYes, mbNo],0)=mrYes
      then //???? ???????????? ????? ?? "Yes", ?? ???????? ??????????.
 begin
       Memo1.Lines.Add('['+timetostr(time)+'] - ???? ?????????? ??????????!');
       FileOnNet := link.caption; //???? ?????? ??  ??????????
       LocalFileName := 'Project.exe'; //????????? ??????????, ?.?. ???? ????? ????????? ??????????.
       if GetInetFile(FileOnNet, LocalFileName) = True then
       Memo1.Lines.Add('['+timetostr(time)+'] - ?????????? ???????????!');
       ShowMessage('???????? ???????? ?????????!') //???? ???????????? ?? ?????? "??", ????????? ?? ???????????.
       ShellExecute(Handle, nil, PChar(LocalFileName), nil, nil, SW_SHOW); //? ????????? ????????? ??????????
       Close; //?????????? ????????? ?????????!
 else
       ShowMessage('??????! ?????????? ?? ??????????!') //???? ??????
 end
 end
 end
 end
 end
 else //????
       Showmessage('?????????? ? ?????????? ???????????!'); //???? ??? ?????????? ? ?????????? ??????? ??? ?????????!
 // ??? ????? ???????? ?????????? ? ??????????.
 end;*)

end.
